package us.bridgeses.Minder;

import android.app.Activity;
import android.app.FragmentManager;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.view.View;

/**
 * Created by Tony on 9/13/2014.
 */
public class EditRepeat extends Activity{

    Reminder reminder;
    RepeatFragment mFragment;
    private static final String TAG_REPEAT_FRAGMENT = "repeat_fragment";

    private void setDaysOfWeek(SharedPreferences sharedPreferences, Reminder reminder) {
        byte daysOfWeek = 0;
        if (sharedPreferences.getBoolean("temp_sunday",false)) {
            daysOfWeek += Reminder.SUNDAY;
        }
        if (sharedPreferences.getBoolean("temp_monday",false)) {
            daysOfWeek += Reminder.MONDAY;
        }
        if (sharedPreferences.getBoolean("temp_tuesday",false)) {
            daysOfWeek += Reminder.TUESDAY;
        }
        if (sharedPreferences.getBoolean("temp_wednesday",false)) {
            daysOfWeek += Reminder.WEDNESDAY;
        }
        if (sharedPreferences.getBoolean("temp_thursday",false)) {
            daysOfWeek += Reminder.THURSDAY;
        }
        if (sharedPreferences.getBoolean("temp_friday",false)) {
            daysOfWeek += Reminder.FRIDAY;
        }
        if (sharedPreferences.getBoolean("temp_saturday",false)) {
            daysOfWeek += Reminder.SATURDAY;
        }
        reminder.setDaysOfWeek(daysOfWeek);
    }

    public void cancel(View view){
        Intent intent = new Intent();
        Bundle bundle = new Bundle();
        bundle.putParcelable("Reminder", reminder);
        intent.putExtras(bundle);
        setResult(RESULT_CANCELED, intent);
        finish();
    }

    public void save(View view){
        SharedPreferences sharedPreferences = PreferenceManager.getDefaultSharedPreferences(this);
        reminder.setRepeatType(Integer.parseInt(sharedPreferences.getString("temp_repeat_type", "0")));
        switch (reminder.getRepeatType()) {
            case 1: {
                reminder.setRepeatLength(Integer.parseInt(sharedPreferences.getString("temp_days", "1")));
                break;
            }
            case 2: {
                reminder.setRepeatLength(Integer.parseInt(sharedPreferences.getString("temp_weeks", "1")));
                setDaysOfWeek(sharedPreferences,reminder);
                break;
            }
            case 3: {
                reminder.setRepeatLength(Integer.parseInt(sharedPreferences.getString("temp_months", "1")));
                reminder.setMonthType((byte) Integer.parseInt(sharedPreferences.getString("temp_monthly_type","0")));
                break;
            }
            case 4: {
                reminder.setRepeatLength(Integer.parseInt(sharedPreferences.getString("temp_years", "1")));
                break;
            }
        }

        Intent intent = new Intent();
        Bundle bundle = new Bundle();
        bundle.putParcelable("Reminder", reminder);
        intent.putExtras(bundle);
        setResult(RESULT_OK, intent);
        finish();
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        setContentView(R.layout.repeat_preference);

        Intent intent = getIntent();
        Bundle incoming = intent.getExtras();
        if (incoming != null) {
            reminder = incoming.getParcelable("Reminder");
            if (reminder.getId()==-1){
                reminder = new Reminder();
            }
        }
        else
            reminder = new Reminder();

        RepeatFragment fragment = RepeatFragment.newInstance(reminder);
        FragmentManager fragmentManager = getFragmentManager();
        mFragment = (RepeatFragment) fragmentManager.findFragmentByTag(TAG_REPEAT_FRAGMENT);

        if (mFragment == null) {
            fragmentManager.beginTransaction().replace(R.id.reminder_frame, fragment,TAG_REPEAT_FRAGMENT).commit();
        }
    }
}
